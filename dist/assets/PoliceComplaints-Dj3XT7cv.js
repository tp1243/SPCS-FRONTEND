import{r as l,j as e}from"./charts-FoNSDMOs.js";import{d as k,b as J}from"./index-BMC4Z6Sv.js";import{p as y}from"./PoliceDashboard-B_6WCH-t.js";import{u as F}from"./useNotificationSound-Cx2IYJLs.js";import"./react-BzrpNAyj.js";import"./icons-CvT1UHUk.js";import"./pdf-DU8byqIM.js";import"./BrandIcon-CHAwuYok.js";import"./api-BjEggnHr.js";import"./NotificationToast-CycjYKEj.js";import"./index-wqQdJ3sC.js";function se({token:d,filter:m,categoryFilter:p,officer:h}){const[i,x]=l.useState([]),[j,S]=l.useState(""),[I,O]=l.useState(null),[P,w]=l.useState(!0),[v,D]=l.useState(""),[N,T]=l.useState(""),[C,_]=l.useState("newest"),u=F({volume:.85,cooldownMs:0}),b=l.useRef(!0),A=l.useRef([]);l.useEffect(()=>{A.current=i},[i]),l.useEffect(()=>{const s=()=>{u.setEnabled(!0),u.prime()},n=()=>{u.setEnabled(!1)};return window.addEventListener("spcs:enable-sound",s),window.addEventListener("spcs:disable-sound",n),()=>{window.removeEventListener("spcs:enable-sound",s),window.removeEventListener("spcs:disable-sound",n)}},[u]),l.useEffect(()=>{try{u.setEnabled(!0),u.prime()}catch{}},[u]),l.useEffect(()=>{let s=!0;w(!0);const n=m==="active"?"active":m==="pending"?"pending":m==="completed"?"completed":"";try{const t=`policeComplaintsCache:${n||"all"}`,a=JSON.parse(localStorage.getItem(t)||"null");a&&Array.isArray(a)&&(x(a),w(!1))}catch{}return y.listComplaints(d,{status:n||void 0,fields:"summary",limit:100}).then(t=>{if(!s)return;let a=t.complaints;if(p){const r=p.toLowerCase();a=a.filter(c=>String(c.category||"").trim().toLowerCase()===r)}x(a),w(!1);try{const r=`policeComplaintsCache:${n||"all"}`;localStorage.setItem(r,JSON.stringify(a))}catch{}}).catch(()=>{w(!1)}),()=>{s=!1}},[d,m,p]),l.useEffect(()=>{const s=setInterval(async()=>{try{const n=m==="active"?"active":m==="pending"?"pending":m==="completed"?"completed":"";let a=(await y.listComplaints(d,{status:n||void 0,fields:"summary",limit:100})).complaints;if(p){const o=p.toLowerCase();a=a.filter(g=>String(g.category||"").trim().toLowerCase()===o)}const r=new Set(A.current.map(o=>o._id)),c=new Set(a.map(o=>o._id));let f=!1;for(const o of c)if(!r.has(o)){f=!0;break}x(a),A.current=a,!b.current&&f&&u.play(),b.current&&(b.current=!1)}catch{}},3e4);return()=>clearInterval(s)},[d,m,p,u]);const R=["Pending","Under Review","In Progress","Solved"],U=l.useMemo(()=>{const s=["Robbery","Fraud","Harassment","Accident","Assault","Theft"],n=Array.from(new Set(i.map(t=>t.type).filter(Boolean)));return Array.from(new Set([...s,...n])).sort((t,a)=>t.localeCompare(a))},[i]),B=l.useMemo(()=>{const s=j.trim().toLowerCase();return i.filter(t=>(!p||String(t.category||"").trim().toLowerCase()===p)&&(!v||t.status===v)&&(!N||t.type===N)&&(s===""||t.title.toLowerCase().includes(s)||(t._id||"").toLowerCase().includes(s)||(t.status||"").toLowerCase().includes(s))).sort((t,a)=>{const r=new Date(t.createdAt||0).getTime(),c=new Date(a.createdAt||0).getTime();return C==="newest"?c-r:r-c})},[i,j,v,N,C]);async function $(s){if(!(!s||!h))try{const n=await y.assignComplaint(d,s);x(t=>t.map(a=>a._id===s?{...a,assignedOfficerName:n.complaint.assignedOfficerName}:a))}catch(n){O(n.message||"Assign failed")}}async function M(s,n){if(!(!s||!n))try{const t=await y.updateComplaintStatus(d,s,n);x(a=>a.map(r=>r._id===s?{...r,status:t.complaint.status}:r));try{window.dispatchEvent(new CustomEvent("spcs:complaint-status-updated",{detail:{id:s,status:t.complaint.status}}))}catch{}try{const a=c=>c==="Solved"?"completed":c==="In Progress"?"active":"pending",r=["all","active","pending","completed"];for(const c of r){const f=`policeComplaintsCache:${c}`,o=JSON.parse(localStorage.getItem(f)||"[]");if(Array.isArray(o)&&o.length){const g=o.findIndex(L=>String(L._id)===String(s));if(g>=0){const L={...o[g],status:t.complaint.status},E=o.slice();E.splice(g,1),(c==="all"||a(t.complaint.status||"Pending")===c)&&E.unshift(L),localStorage.setItem(f,JSON.stringify(E))}}}}catch{}}catch(t){O(t.message||"Update failed")}}return e.jsxs("div",{className:"panel",children:[e.jsxs("div",{className:"table-toolbar",children:[e.jsxs("div",{className:"search","aria-label":"Search complaints",children:[e.jsx(k,{}),e.jsx("input",{value:j,onChange:s=>S(s.target.value),placeholder:"Search by title, ID, status"})]}),e.jsxs("div",{className:"filters",children:[e.jsx("span",{className:`pill ${v===""?"active":""}`,onClick:()=>D(""),children:"All Status"}),R.map(s=>e.jsx("span",{className:`pill ${v===s?"active":""}`,onClick:()=>D(s),children:s},s))]}),e.jsxs("div",{className:"sort",children:[e.jsx("span",{className:"muted",children:"Type"}),e.jsxs("select",{className:"sort-select",value:N,onChange:s=>T(s.target.value),children:[e.jsx("option",{value:"",children:"All Types"}),U.map(s=>e.jsx("option",{value:s,children:s},s))]})]}),e.jsxs("div",{className:"sort",children:[e.jsx("span",{className:"muted",children:"Sort"}),e.jsxs("select",{className:"sort-select",value:C,onChange:s=>_(s.target.value),children:[e.jsx("option",{value:"newest",children:"Newest"}),e.jsx("option",{value:"oldest",children:"Oldest"})]})]})]}),I&&e.jsx("div",{className:"form-error",children:I}),P?e.jsx("div",{className:"muted",children:"Loading complaintsâ€¦"}):e.jsxs("div",{className:"table",children:[e.jsxs("div",{className:"thead",children:[e.jsx("div",{children:"ID"}),e.jsx("div",{children:"Title"}),e.jsx("div",{children:"Date"}),e.jsx("div",{children:"Status"}),e.jsx("div",{children:"Assigned"}),e.jsx("div",{children:"Actions"})]}),B.map(s=>e.jsxs("div",{className:"trow",children:[e.jsx("div",{children:s._id?.slice(-6)}),e.jsxs("div",{className:"title-cell",title:s.title,children:[s.photoUrl?e.jsx("img",{className:"thumb",src:s.photoUrl,alt:"complaint photo"}):e.jsx("span",{className:"thumb placeholder","aria-hidden":!0}),e.jsx("span",{className:"title-text",children:s.title})]}),e.jsx("div",{children:new Date(s.createdAt||"").toLocaleDateString()}),e.jsx("div",{children:s.status?e.jsx("span",{className:`badge ${s.status.replace(/\s/g,"-").toLowerCase()}`,children:s.status}):"-"}),e.jsx("div",{children:s.assignedOfficerName||"-"}),e.jsxs("div",{style:{display:"flex",gap:8},children:[e.jsx(q,{item:s,token:d}),e.jsx("button",{className:"btn sm ghost",onClick:()=>$(s._id),disabled:!h||s.assignedOfficerName===h?.username,children:"Assign to me"}),e.jsxs("select",{value:s.status||"Pending",onChange:n=>M(s._id,n.target.value),className:"sort-select",style:{paddingRight:24},disabled:(s.status||"")==="Solved",children:[e.jsx("option",{children:"Pending"}),e.jsx("option",{children:"Under Review"}),e.jsx("option",{children:"In Progress"}),e.jsx("option",{children:"Solved"})]})]})]},s._id)),B.length===0&&e.jsx("div",{className:"muted",style:{padding:10},children:"No complaints match filters."})]})]})}function q({item:d,token:m}){const[p,h]=l.useState(!1),[i,x]=l.useState(d);async function j(){h(!0);try{const S=await y.getComplaintById(m,String(d._id||""));x(S.complaint)}catch{}}return e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn sm",onClick:j,children:"View Details"}),p&&e.jsx("div",{className:"modal",children:e.jsxs("div",{className:"modal-body",children:[e.jsx("button",{className:"icon-btn close","aria-label":"Close",onClick:()=>h(!1),children:e.jsx(J,{})}),e.jsx("h3",{style:{marginBottom:6},children:i.title}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(2, minmax(0, 1fr))",gap:12,marginBottom:10},children:[e.jsxs("div",{children:[e.jsx("span",{className:"muted",children:"Type"}),e.jsx("div",{children:i.type||"-"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"muted",children:"Category"}),e.jsx("div",{children:(i.category||"-").toUpperCase()})]}),e.jsxs("div",{children:[e.jsx("span",{className:"muted",children:"Status"}),e.jsx("div",{children:i.status?e.jsx("span",{className:`badge ${String(i.status).replace(/\s/g,"-").toLowerCase()}`,children:i.status}):"-"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"muted",children:"Filed On"}),e.jsx("div",{children:i.createdAt?new Date(i.createdAt).toLocaleString():"-"})]})]}),i.photoUrl&&e.jsx("img",{src:i.photoUrl,alt:"evidence",style:{width:"100%",maxHeight:280,objectFit:"cover",borderRadius:10,marginBottom:10}}),i.location?.address&&e.jsxs("div",{style:{marginBottom:10},children:[e.jsx("span",{className:"muted",children:"Location"}),e.jsx("div",{children:i.location.address})]}),i.description?.trim()&&e.jsxs("div",{className:"modal-desc",style:{marginBottom:10},children:[e.jsx("span",{className:"muted",children:"Description"}),e.jsx("div",{style:{whiteSpace:"pre-wrap"},children:i.description})]}),e.jsxs("div",{style:{marginBottom:10},children:[e.jsx("span",{className:"muted",children:"Assigned Officer"}),e.jsx("div",{children:i.assignedOfficerName||i.assignedOfficer||"-"})]}),e.jsx("div",{style:{display:"flex",justifyContent:"flex-end",gap:8},children:e.jsx("button",{className:"btn",onClick:()=>h(!1),children:"Close"})})]})})]})}export{se as default};
